package @@package@@.models

import java.time._
import java.util.Date
import com.twitter.util.Future
import shapeless._
import shapeless.syntax.std.tuple._
import io.circe.java8._
import maiden.traits._
import maiden.models.@@dbType@@._
import db._
import maiden.exceptions._
import maiden.processing.Formatters._
import @@appNameUpper@@Schema._
import maiden.implicits.ExecutionImplicits._


case class @@model@@FullResponse (
  @@baseFields@@

  @@refFields@@
) extends MaidenFullResponse

object @@model@@FullResponse {

  implicit val @@lowerCaseModel@@Gen = Generic[@@model@@]
  implicit val @@lowerCaseModel@@FullResponseGen = Generic[@@model@@FullResponse]

  @@fullResponseBuild@@

  def extract(t: @@model@@FullResponse) =
    val values = @@lowerCaseModel@@.to(t).slice(0, @@baseModelFieldCount@@)
    @@lowerCaseModel@@Gen.from(values)

}

case class @@model@@ (
  @@baseFields@@
) extends MaidenModel {

  def save() = id match {
    case Some(i) if i != -1l => {
      if (@@model@@.exists(i)) {
        @@model@@.update(this)
      } else {
        @@model@@.create(this)
      }
    }
    case _ => @@model@@.create(this)
  }

  def delete() = id match {
    case Some(i) => @@model@@.deleteBy("id", i)
    case _ => -1l
  }

  def format() = @@model@@(@@formattedCols@@)

}

object @@model@@ extends MaidenModelObject[@@model@@, @@model@@FullResponse] {

  def exists(id: Long) = {
    val q = quote {
      @@queryName@@.filter(_.id == lift(id))
    }

    db.run(q.size) match {
      case x: Long if x > 0 => true
      case _ => false
    }
  }

  def get(id: Long) =
    findBy("id", id).headOption match {
      case Some(x) => x
      case _ => throw new EntityNotFoundException
    }

  @@magicMethods@@

  @@referenceMethods@@

}